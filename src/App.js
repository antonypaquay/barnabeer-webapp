import React, { Fragment } from "react";
import "./App.scss";
import Beer from "./components/Beer";
import firebase from "firebase/app";
import "firebase/auth";
import Login from "./components/Login";
import base, { firebaseApp } from "./base";
import logoutImg from "./img/logout.png";
import Header from "./components/Header";

import { Link } from "react-router-dom";

class App extends React.Component {
	state = {
		beers: {},
		user: this.props.match.params.user,
		//----
		uid: null,
		fbuser: null
	};

	componentDidMount() {
		base.syncState(`/users/${this.state.user}/beers`, {
			context: this,
			state: "beers"
		});
		//-----
		firebase.auth().onAuthStateChanged(user => {
			if (user) {
				// passer le user sous forme d'object
				this.handleAuth({ user });
			}
		});
	}

	//NOTE  async & await permet t'attendre qu'une instruction soit terminée pour passer à la ligne suivante
	handleAuth = async authData => {
		// récupérer les données dans firebase
		const box = await base.fetch(this.state.user, {
			context: this
		});

		if (!box.fbuser) {
			await base.post(`/users/${this.state.user}/user-uid`, {
				data: authData.user.uid
			});
		}

		this.setState({
			uid: authData.user.uid,
			fbuser: box.fbuser || authData.user.uid
		});
	};

	// permet de se connecter via firebase
	authenticate = () => {
		// ajouter le provider
		const authProvider = new firebase.auth.FacebookAuthProvider();
		// appeller le l'application firebase
		firebaseApp
			.auth()
			// mode de connexion -> type popup
			.signInWithPopup(authProvider)
			// une fois que la promesse nous renvoie quelque chose on exécute then()
			.then(this.handleAuth);
	};

	logout = async () => {
		console.log("Déconnexion");
		await firebase.auth().signOut();
		this.setState({
			uid: null
		});
	};

	handleClick = e => {
		base.fetch(`/beers`, {
			context: this,
			state: "beers",
			then(data) {
				const beers = data;
				this.setState({ beers });
			}
		});
	};

	isTasted = (key, newBeer) => {
		const beers = { ...this.state.beers };
		beers[key] = newBeer;
		this.setState({ beers });
	};

	render() {
		const logout = (
			<button className="btn__img" onClick={this.logout}>
				<img src={logoutImg} alt={"logout"} />
			</button>
		);

		// si l'utilisateur n'est pas connecté
		if (!this.state.uid) {
			return (
				<Login user={this.state.user} authenticate={this.authenticate}></Login>
			);
		}

		if (this.state.uid !== this.state.fbuser) {
			return (
				<div>
					<p>Tu n'es pas le chef de cette boite !</p>
					{logout}
				</div>
			);
		}

		const beers = Object.keys(this.state.beers).map((key, index) => {
			const {
				beer_name,
				beer_cl,
				beer_pourcent,
				beer_type,
				beer_price,
				beer_id,
				beer_tasted
			} = this.state.beers[key];

			return (
				<Beer
					beers={this.state.beers}
					key={beer_id}
					id={key}
					beerTasted={beer_tasted}
					isTasted={this.isTasted}
					beerName={beer_name}
					beerCl={beer_cl}
					beerPourcent={beer_pourcent}
					beerType={beer_type}
					beerPrice={beer_price}
				/>
			);
		});

		const welcome = (
			<div className="welcome">
				<h2>Bonjour {this.state.user}</h2>
				<p>
					Bienvenue sur la nouvelle app du Barnabeer, celle-ci te permettra de
					découvrir nos produits ainsi qu'indiquer ceux que tu as déjà dégusté
					et bien plus encore! Alors tu es près à découvrir l'expérience
					Barnabeer?
				</p>
				<button className="btn" onClick={this.handleClick}>
					Afficher les bières!
				</button>
			</div>
		);

		return (
			<Fragment>
				<Header
					beersLength={this.state.beers.lenght}
					handleClick={this.handleClick}
					logOut={logout}
				/>
				<section className="section__beers">
					<div className="wrapper">
						{this.state.beers.length > 0 ? null : welcome}
						<ul className="beers__list">{beers}</ul>
					</div>
				</section>
				<div className="subnav">
					<ul className="subnav__ul">
						
						
						<li className="subnav__ul__li">
							<Link to="/tasted">
							<svg viewBox="0 0 80 80">
    <g id="heart" stroke="none" strokeWidth="1" fill="none" fillRule="evenodd">
        <g transform="translate(0.000000, 3.000000)" fill="#000000" fillRule="nonzero" id="Shape">
            <path d="M40,74 C38.8610841,74 37.7630616,73.5710219 36.9073486,72.7917539 C33.6755372,69.8536344 30.5596923,67.0925634 27.8106689,64.6570335 L27.7966309,64.6443419 C19.7369384,57.5033787 12.7770997,51.3365005 7.93457031,45.2616368 C2.52136234,38.470329 0,32.0312146 0,24.9968614 C0,18.1624018 2.25402828,11.8571845 6.34643562,7.2418619 C10.4876709,2.57196511 16.1700439,0 22.3486328,0 C26.9665528,0 31.1956787,1.51792268 34.9182128,4.51125095 C36.796875,6.02219318 38.4997559,7.8713683 40,10.0283162 C41.5008545,7.8713683 43.203125,6.02219318 45.0823975,4.51125095 C48.8049316,1.51792268 53.0340577,0 57.6519775,0 C63.8299561,0 69.5129394,2.57196511 73.6541748,7.2418619 C77.746582,11.8571845 80,18.1624018 80,24.9968614 C80,32.0312146 77.4792481,38.470329 72.06604,45.2610023 C67.2235108,51.3365005 60.2642822,57.5027442 52.2058106,64.6430728 C49.4519044,67.0824101 46.3311767,69.847923 43.0920409,72.7930231 C42.2369384,73.5710219 41.1383056,74 40,74 L40,74 Z M22.3486328,4.87232883 C17.4945069,4.87232883 13.0352783,6.88649539 9.79125969,10.5442322 C6.49902344,14.2571777 4.68566891,19.3896855 4.68566891,24.9968614 C4.68566891,30.9130792 6.80053719,36.2042328 11.5423584,42.1528144 C16.1254883,47.9027716 22.9425048,53.9427331 30.8355713,60.936473 L30.8502197,60.9491648 C33.6096191,63.3942133 36.7376709,66.1660721 39.9932861,69.1257675 C43.2684327,66.1603608 46.4013672,63.38406 49.1662597,60.9352039 C57.0587158,53.941464 63.875122,47.9027716 68.4582519,42.1528144 C73.1994628,36.2042328 75.3143311,30.9130792 75.3143311,24.9968614 C75.3143311,19.3896855 73.5009766,14.2571777 70.2087403,10.5442322 C66.965332,6.88649539 62.5054931,4.87232883 57.6519775,4.87232883 C54.0960694,4.87232883 50.8312987,6.0475765 47.9486084,8.365074 C45.3796387,10.4312765 43.5900878,13.0432202 42.5408936,14.8708194 C42.0013428,15.810637 41.0516358,16.3716085 40,16.3716085 C38.9483642,16.3716085 37.9986572,15.810637 37.4591064,14.8708194 C36.4105225,13.0432202 34.6209717,10.4312765 32.0513916,8.365074 C29.1687012,6.0475765 25.9039306,4.87232883 22.3486328,4.87232883 Z"></path>
        </g>
    </g>
</svg>
							</Link>
						</li>
						<li className="subnav__ul__li">
							<Link to={`/beers/${this.state.user}`}>
							<svg viewBox="0 0 80 80">
    <g stroke="none" strokeWidth="1" fill="none" fillRule="evenodd">
        <g transform="translate(0.000000, 3.000000)" fill="#000000" fillRule="nonzero" id="Shape">
            <path d="M77.8515739,32.1864318 C77.8491323,32.1847382 77.847301,32.1824799 77.8454697,32.1807861 L45.2085062,1.99577335 C43.8173744,0.708541906 41.9678223,0 40.0004604,0 C38.0330987,0 36.1835466,0.708541906 34.7918045,1.99577335 L2.17193248,32.1655426 C2.16094496,32.175705 2.14934707,32.1864318 2.13897009,32.1965942 C-0.717763785,34.8540497 -0.712880479,39.1657104 2.15300963,41.816391 C3.46234595,43.0279693 5.19103619,43.7291718 7.0399778,43.803131 C7.11566904,43.8099061 7.19136028,43.8132935 7.26766189,43.8132935 L8.56784213,43.8132935 L8.56784213,66.0270692 C8.56784213,70.4234161 12.4354203,74 17.1887081,74 L29.9573317,74 C31.2520183,74 32.3013185,73.0289307 32.3013185,71.8320312 L32.3013185,54.4160156 C32.3013185,52.41008 34.0660232,50.7784576 36.2348213,50.7784576 L43.7660997,50.7784576 C45.9348978,50.7784576 47.6989921,52.41008 47.6989921,54.4160156 L47.6989921,71.8320312 C47.6989921,73.0289307 48.7482923,74 50.0429789,74 L62.8116026,74 C67.5655007,74 71.4324685,70.4234161 71.4324685,66.0270692 L71.4324685,43.8132935 L72.638645,43.8132935 C74.6053964,43.8132935 76.4549485,43.1047516 77.847301,41.8169556 C80.7162431,39.1623231 80.7174639,34.8427582 77.8515739,32.1864318 L77.8515739,32.1864318 Z M74.2246393,39.242516 C73.7231102,39.708198 73.0564211,39.9649129 72.3479886,39.9649129 L68.8294195,39.9649129 C67.546255,39.9649129 66.5062928,40.9305431 66.5062928,42.1219925 L66.5062928,66.3812743 C66.5062928,68.3765729 64.7578979,70 62.6084007,70 L52.2765366,70 L52.2765366,54.8285398 C52.2765366,50.4542744 48.4439824,46.895093 43.732391,46.895093 L36.2681364,46.895093 C31.556545,46.895093 27.7233858,50.4542744 27.7233858,54.8285398 L27.7233858,70 L17.3915218,70 C15.2426295,70 13.4936297,68.3765729 13.4936297,66.3812743 L13.4936297,42.1219925 C13.4936297,40.9305431 12.4536674,39.9649129 11.1705029,39.9649129 L7.71243198,39.9649129 C7.67613312,39.9626659 7.64043921,39.9609807 7.60353541,39.960419 C6.91143724,39.9491842 6.26229275,39.6941544 5.77588809,39.2419541 C4.74137064,38.2813797 4.74137064,36.7180586 5.77588809,35.7569223 C5.77649303,35.7569223 5.77649303,35.7563606 5.77709797,35.7557989 L5.77891295,35.7541137 L38.1242178,5.72183521 C38.625142,5.25615321 39.2912261,5 40.0002636,5 C40.7086963,5 41.3747803,5.25615321 41.8763096,5.72183521 L74.2143547,35.7479345 C74.2191945,35.7524284 74.2246393,35.7569223 74.2294791,35.7614162 C75.2585517,36.723676 75.2567368,38.2836266 74.2246393,39.242516 Z"></path>
        </g>
    </g>
</svg>
							</Link>
						</li>
						<li className="subnav__ul__li">
							<Link to="/profile">
							<svg viewBox="0 0 80 80">
    <g id="user" stroke="none" strokeWidth="1" fill="none" fillRule="evenodd">
        <g transform="translate(12.000000, 3.000000)" fill="#000000" fillRule="nonzero" id="Shape">
            <path d="M27.8674316,38.5363769 C33.1616211,38.5363769 37.7453612,36.6375733 41.4916992,32.8912353 C45.2368164,29.1455078 47.1362305,24.562378 47.1362305,19.2675781 C47.1362305,13.9746094 45.2374267,9.39086906 41.4910889,5.64392094 C37.7447509,1.89880375 33.1610108,0 27.8674316,0 C22.5726319,0 17.9895019,1.89880375 14.2437744,5.64453125 C10.4980469,9.39025875 8.59863281,13.9739991 8.59863281,19.2675781 C8.59863281,24.562378 10.4980469,29.1461181 14.2437744,32.8918456 C17.9907227,36.6369628 22.5744628,38.5363769 27.8674316,38.5363769 Z M17.5592041,8.95935063 C20.4333497,6.085205 23.8049316,4.68811031 27.8674316,4.68811031 C31.9293212,4.68811031 35.3015137,6.085205 38.1762695,8.95935063 C41.050415,11.8341064 42.4481202,15.2062988 42.4481202,19.2675781 C42.4481202,23.3300781 41.050415,26.7016602 38.1762695,29.5764159 C35.3015137,32.4511719 31.9293212,33.8482666 27.8674316,33.8482666 C23.8061523,33.8482666 20.4345703,32.4505616 17.5592041,29.5764159 C14.6844483,26.7022705 13.2867431,23.3300781 13.2867431,19.2675781 C13.2867431,15.2062988 14.6844483,11.8341064 17.5592041,8.95935063 Z"></path>
            <path d="M55.864294,58.3572072 C55.7736526,57.0379728 55.5903213,55.598902 55.3204456,54.0792514 C55.0480093,52.5482372 54.6972219,51.1009017 54.2773014,49.7780517 C53.843042,48.4107794 53.2536168,47.0605529 52.5238767,45.7666288 C51.7675074,44.4236338 50.8785047,43.254195 49.8809372,42.2918875 C48.8377929,41.2851577 47.5606196,40.4757449 46.0837282,39.8853437 C44.6119575,39.2980416 42.9809244,39.0005165 41.2362054,39.0005165 C40.5510178,39.0005165 39.8883626,39.2840952 38.6086289,40.1245 C37.8210217,40.6425862 36.8997568,41.2417686 35.8714634,41.904485 C34.9921906,42.4695761 33.8010498,42.999026 32.3297914,43.4783719 C30.8943797,43.9468705 29.436948,44.1844774 27.9979516,44.1844774 C26.5599795,44.1844774 25.1025478,43.9468705 23.666112,43.4783719 C22.1963897,42.9995425 21.0047369,42.4700926 20.1270004,41.9050015 C19.1084368,41.2484836 18.1866598,40.6493012 17.3872743,40.1239835 C16.1085649,39.2835787 15.4459096,39 14.7607221,39 C13.015491,39 11.3849699,39.2980416 9.91371148,39.8858602 C8.43784404,40.4752284 7.16015882,41.2846412 6.11599031,42.292404 C5.11842278,43.2552281 4.22942009,44.4241504 3.47356296,45.7666288 C2.74484701,47.0605529 2.15490975,48.4102629 1.72065037,49.7785682 C1.30124181,51.1014183 0.950454488,52.5482372 0.67801818,54.0792514 C0.407630265,55.5968359 0.224811197,57.0364233 0.134169826,58.3587568 C0.0450646525,59.6516478 0,60.9972255 0,62.3567497 C0,65.8908927 1.11381389,68.7519887 3.31020356,70.8620404 C5.47945206,72.9441993 8.34925107,74 11.8402253,74 L44.1597747,74 C47.6497248,74 50.5195238,72.9441993 52.6892844,70.8620404 C54.8861862,68.7535383 56,65.8914093 56,62.3562331 C56,60.9920601 55.9539112,59.6464824 55.864294,58.3572072 L55.864294,58.3572072 Z M49.9164184,67.9596289 C48.4870201,69.3325889 46.5893268,70 44.114563,70 L11.8849264,70 C9.40965185,70 7.51195856,69.3325889 6.08307093,67.9601442 C4.68124953,66.6134685 4,64.7751245 4,62.3415221 C4,61.0757602 4.04136519,59.8259749 4.1240957,58.626181 C4.20478335,57.4490638 4.36973359,56.1559869 4.61435019,54.7819963 C4.85590263,53.425013 5.16333311,52.1515204 5.52898126,50.9986256 C5.87981953,49.8931455 6.35832843,48.7984882 6.95174057,47.7440303 C7.51808661,46.7390483 8.16971667,45.8768253 8.88875659,45.1820994 C9.56132443,44.5322111 10.4090562,44.0003437 11.4079497,43.6014431 C12.3317729,43.2324343 13.3699889,43.0304072 14.4970636,43 C14.634437,43.0736987 14.8790536,43.2143962 15.2753426,43.4751762 C16.0817091,44.0054974 17.01115,44.6105481 18.0386417,45.2728054 C19.1968679,46.0180381 20.6890799,46.6911184 22.47187,47.2719465 C24.2944931,47.8666896 26.1533748,48.1686996 27.9984679,48.1686996 C29.8435612,48.1686996 31.7029535,47.8666896 33.5245553,47.2724618 C35.3088774,46.6906031 36.8005789,46.0180381 37.960337,45.2717746 C39.0118308,44.5935408 39.9152268,44.0060127 40.7215934,43.4751762 C41.1178824,43.2149116 41.362499,43.0736987 41.4998724,43 C42.6274577,43.0304072 43.6656737,43.2324343 44.5900077,43.6014431 C45.5883906,44.0003437 46.4361222,44.5327264 47.1086902,45.1820994 C47.8277301,45.87631 48.47936,46.738533 49.0457061,47.7445457 C49.639629,48.7984882 50.1186484,49.8936609 50.4689761,50.9981103 C50.8351349,52.1525511 51.1430761,53.4255283 51.3841179,54.7814809 C51.6282237,56.1580484 51.7936846,57.4516407 51.8743724,58.6266965 L51.8743724,58.6277272 C51.9576135,59.8228827 51.9994894,61.0721526 52,62.3415221 C51.9994894,64.77564 51.3182398,66.6134685 49.9164184,67.9596289 L49.9164184,67.9596289 Z"></path>
        </g>
    </g>
</svg>
							</Link>
						</li>
					</ul>
				</div>
			</Fragment>
		);
	}
}

export default App;
